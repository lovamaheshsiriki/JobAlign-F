<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - JobAlign</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../data/font/fontawesome-free-7.1.0-web/css/all.min.css">
    <style>
        /* 1. Global Reset and Variables */
        :root {
            --color-primary: #2563EB; /* Blue */
            --color-primary-light: #EFF6FF;
            --color-dark: #0F172A;   /* Dark Blue/Black for text */
            --color-secondary: #64748B; /* Gray for body text */
            --color-light-gray: #F1F5F9; 
            --color-bg: #F8FAFC;
            --color-white: #FFFFFF;
            --color-border: #E2E8F0;
            --color-danger: #DC2626;
            
            --font-family-sans: 'Inter', sans-serif;
            --border-radius: 0.75rem;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transition-fast: 0.2s ease-in-out;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-sans);
            background-color: var(--color-bg);
            color: var(--color-secondary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .placeholder-text {
            text-align: center;
            padding: 1rem;
            font-style: italic;
            color: var(--color-secondary);
        }

        /* 2. Header / Navbar */
        .header {
            background-color: var(--color-white);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow);
            position: sticky; top: 0; z-index: 1000;
        }
        .navbar {
            display: flex; align-items: center; justify-content: space-between;
            max-width: 1200px; margin: 0 auto;
        }
        .logo {
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 1.5rem; font-weight: 700; color: var(--color-dark); text-decoration: none;
        }
        .logo i { color: var(--color-primary); }
        .nav-center { flex-grow: 1; display: flex; justify-content: center; }
        .nav-right { display: flex; align-items: center; gap: 1.5rem; }
        .main-nav { display: none; }
        .main-nav ul { display: flex; list-style: none; gap: 2rem; align-items: center;}
        .main-nav a {
            font-weight: 500; color: var(--color-secondary); transition: var(--transition-fast);
            text-decoration: none; padding-bottom: 0.5rem;
        }
        .main-nav a:hover, .main-nav a.active {
            color: var(--color-primary); border-bottom: 2px solid var(--color-primary);
        }
        .profile-icon img { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; object-fit: cover; }
        .menu-toggle { display: block; font-size: 1.5rem; cursor: pointer; background: none; border: none; color: var(--color-dark); }
        
        .main-nav.active ul {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 70px;
            right: 20px;
            background-color: var(--color-white);
            width: 200px;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            padding: 1rem;
            gap: 1rem;
            z-index: 1001;
        }

        @media (min-width: 992px) {
            .main-nav { display: block; }
            .menu-toggle { display: none; }
        }

        /* 3. Main Profile Layout */
        .profile-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .profile-layout { grid-template-columns: 2fr 1fr; }
        }

        /* 4. Reusable Card Component */
        .card {
            background-color: var(--color-white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem;
        }
        .card-header h2 { color: var(--color-dark); font-size: 1.25rem; }
        
        /* 5. Buttons */
        .btn {
            padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600;
            cursor: pointer; transition: var(--transition-fast); border: 1px solid transparent;
            text-decoration: none; display: inline-block;
        }
        .btn-primary { background-color: var(--color-primary); color: var(--color-white); border-color: var(--color-primary); }
        .btn-primary:hover:not(:disabled) { background-color: #1D4ED8; border-color: #1D4ED8; }
        .btn-primary:disabled { background-color: #9CA3AF; border-color: #9CA3AF; cursor: not-allowed; }
        .btn-secondary { background-color: var(--color-white); color: var(--color-dark); border-color: var(--color-border); }
        .btn-secondary:hover { border-color: var(--color-primary); color: var(--color-primary); }
        .btn-danger { background-color: var(--color-danger); color: var(--color-white); border-color: var(--color-danger); }
        .btn-icon { background: none; border: none; color: var(--color-secondary); cursor: pointer; font-size: 1rem; padding: 0.5rem; }
        .btn-icon:hover { color: var(--color-primary); }

        /* 6. Profile Header Card - FIX */
        .profile-header-card { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 1rem; 
            text-align: center; 
        }
        @media (min-width: 640px) {
            .profile-header-card { 
                flex-direction: row; 
                text-align: left; 
                align-items: center; /* Ensure vertical alignment */
            }
        }
        .profile-picture { 
            position: relative; 
            flex-shrink: 0; /* Prevents image from shrinking */
        }
        .profile-picture img { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--color-white); box-shadow: var(--shadow); object-fit: cover; }
        .profile-picture .edit-pic {
            position: absolute; bottom: 5px; right: 5px; background-color: var(--color-primary);
            color: var(--color-white); width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .profile-info { flex-grow: 1; }
        .profile-info h1 { color: var(--color-dark); }
        .profile-info p { margin-bottom: 0.25rem; }
        .profile-contact-info { display: flex; flex-wrap: wrap; gap: 0.5rem 1.5rem; justify-content: center; }
        @media (min-width: 640px) { .profile-contact-info { justify-content: flex-start; } }
        
        .profile-header-card .edit-profile-btn { 
            margin-top: 1rem; 
            flex-shrink: 0; /* Prevents button from shrinking */
        }
        @media (min-width: 640px) { 
            .profile-header-card .edit-profile-btn { 
                margin-left: auto; 
                margin-top: 0; 
            } 
        }

        /* 7. Experience, Education & Skills List Items */
        .list-item { display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--color-light-gray); }
        .list-item:last-child { border-bottom: none; }
        .list-item-content { flex-grow: 1; }
        .list-item-content h3 { color: var(--color-dark); }
        .list-item-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .skills-list { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .skill-tag {
            background-color: var(--color-primary-light); color: var(--color-primary);
            padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 600;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .skill-tag button { background: none; border: none; color: var(--color-primary); cursor: pointer; font-size: 1rem; padding: 0; }

        /* 8. Resume & Settings */
        .resume-card .btn { width: 100%; margin-top: 0.5rem; }
        
        /* 9. Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 2rem; border: 1px solid #888;
            width: 90%; max-width: 500px; border-radius: var(--border-radius);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { color: var(--color-dark); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 0.75rem; border: 1px solid var(--color-border);
            border-radius: 0.5rem; font-size: 1rem; font-family: var(--font-family-sans);
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
    </style>
</head>
<body>

    <header class="header">
        <div class="navbar">
            <a href="jobseeker-dashboard.html" class="logo"><i class="fa-solid fa-check-double"></i><span>JobAlign</span></a>
            <div class="nav-center">
                <nav class="main-nav">
                    <ul>
                        <li><a href="jobseeker-dashboard.html">Dashboard</a></li>
                        <li><a href="jobsforjobseeker.html">Jobs</a></li>
                        <li><a href="applicationsforjobseeker.html">Applications</a></li>
                        <li><a href="#" class="active">Profile</a></li>
                        <li><a href="settingsforjobseeker.html">Settings</a></li>
                    </ul>
                </nav>
            </div>
            <div class="nav-right">
                <div class="profile-icon">
                    <a href="profileforjobseeker.html"><img id="profile-pic-nav" src="https://placehold.co/40x40/E2E8F0/475569?text=U" alt="Profile"></a>
                </div>
                <button class="menu-toggle" aria-label="Toggle Navigation"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="profile-layout">
            <div class="main-column">
                <div class="card profile-header-card">
                    <div id="profile-header-content"><p class="placeholder-text">Loading profile...</p></div>
                </div>
                
                <div class="card">
                    <div class="card-header"><h2>About</h2></div>
                    <p id="profile-about"><span class="placeholder-text">Loading...</span></p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Skills</h2>
                        <button class="btn btn-secondary" data-action="open-modal" data-modal-id="add-skill-modal">+ Add Skill</button>
                    </div>
                    <div class="skills-list" id="skills-list-container">
                        <p class="placeholder-text">Loading skills...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Experience</h2>
                        <button class="btn btn-secondary" data-action="open-modal" data-modal-id="experience-modal">+ Add Experience</button>
                    </div>
                    <div id="experience-list-container">
                        <p class="placeholder-text">Loading experience...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Education</h2>
                        <button class="btn btn-secondary" data-action="open-modal" data-modal-id="education-modal">+ Add Education</button>
                    </div>
                    <div id="education-list-container">
                        <p class="placeholder-text">Loading education...</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-column">
                <div class="card resume-card">
                    <div class="card-header"><h2>Resume</h2></div>
                    <a href="#" id="view-resume-btn" class="btn btn-primary" target="_blank" style="display: none;">View Resume</a>
                    <button id="upload-resume-btn" class="btn btn-secondary">Upload/Update Resume</button>
                    <input type="file" id="resume-upload-input" accept=".pdf,.doc,.docx" style="display:none;"/>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <span class="close-btn" data-action="close-modal">&times;</span>
            </div>
            <form id="edit-profile-form">
                <div class="form-group"><label for="fullName">Full Name</label><input type="text" id="fullName" name="fullName" required></div>
                <div class="form-group"><label for="headline">Title / Headline</label><input type="text" id="headline" name="headline"></div>
                <div class="form-group"><label for="email">Email</label><input type="email" id="email" name="email" required></div>
                <div class="form-group"><label for="profile-location-input">Location</label><input type="text" id="profile-location-input" name="location"></div>
                <div class="form-group"><label for="about">About</label><textarea id="about" name="about" rows="4"></textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-skill-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Add Skill</h2><span class="close-btn" data-action="close-modal">&times;</span></div>
            <form id="add-skill-form">
                <div class="form-group"><label for="skill-name">Skill Name (comma-separated)</label><input type="text" id="skill-name" name="skillName" required></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="experience-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="experience-modal-title">Add Experience</h2><span class="close-btn" data-action="close-modal">&times;</span></div>
            <form id="experience-form">
                <input type="hidden" id="experience-id" name="id">
                <div class="form-group"><label for="exp-title">Job Title</label><input type="text" id="exp-title" name="title" required></div>
                <div class="form-group"><label for="exp-company">Company</label><input type="text" id="exp-company" name="company" required></div>
                <div class="form-group"><label for="exp-duration">Duration (e.g., May 2023 - Present)</label><input type="text" id="exp-duration" name="duration"></div>
                <div class="form-group"><label for="exp-description">Description</label><textarea id="exp-description" name="description" rows="3"></textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="education-modal" class="modal">
       <div class="modal-content">
            <div class="modal-header"><h2 id="education-modal-title">Add Education</h2><span class="close-btn" data-action="close-modal">&times;</span></div>
            <form id="education-form">
                <input type="hidden" id="education-id" name="id">
                <div class="form-group"><label for="edu-degree">Degree</label><input type="text" id="edu-degree" name="degree" required></div>
                <div class="form-group"><label for="edu-institution">Institution</label><input type="text" id="edu-institution" name="institution" required></div>
                <div class="form-group"><label for="edu-year">Year of Completion</label><input type="text" id="edu-year" name="year"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === API & Authentication Configuration ===
    const API_BASE_URL = 'http://localhost:5000/api';
    // Backend base (strip the /api suffix) â€” used to build absolute URLs for uploaded files
    const BACKEND_BASE = API_BASE_URL.replace(/\/api$/, '');
    let userProfile = {};

    // Convert a stored file path (e.g. '/uploads/..' or 'uploads/..' or absolute URL) into an absolute URL
    const makeFileUrl = (pth) => {
        if (!pth) return null;
        if (pth.startsWith('http://') || pth.startsWith('https://')) return pth;
        if (pth.startsWith('/')) return BACKEND_BASE + pth;
        return BACKEND_BASE + '/' + pth;
    };

    // === DOM Element References ===
    const profileHeaderContainer = document.getElementById('profile-header-content');
    const aboutContainer = document.getElementById('profile-about');
    const skillsContainer = document.getElementById('skills-list-container');
    const experienceContainer = document.getElementById('experience-list-container');
    const educationContainer = document.getElementById('education-list-container');
    const profilePicNav = document.getElementById('profile-pic-nav');
    const viewResumeBtn = document.getElementById('view-resume-btn');
    const uploadResumeBtn = document.getElementById('upload-resume-btn');
    const resumeUploadInput = document.getElementById('resume-upload-input');
    
    // === Authentication & API Helpers ===
    const parseJwt = (token) => {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload;
        } catch (e) { return null; }
    };
    const handleUnauthorized = () => {
        localStorage.removeItem('token');
        window.location.href = 'loginforjobseeker.html';
    };
    const fetchWithAuth = async (endpoint, options = {}) => {
        const token = localStorage.getItem('token');
        const headers = { 'Authorization': `Bearer ${token}` };
        if (!(options.body instanceof FormData)) {
            headers['Content-Type'] = 'application/json';
        }
        const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
        if (response.status === 401 || response.status === 403) throw new Error('Unauthorized');
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'API Error');
        return data;
    };

    // === Main Page Loader ===
    const loadPage = async () => {
        const token = localStorage.getItem('token');
        if (!token) return handleUnauthorized();
        const decodedToken = parseJwt(token);
        if (!decodedToken || decodedToken.exp * 1000 < Date.now() || (decodedToken.role || '').replace(/_/g, '').toLowerCase() !== 'jobseeker') {
            return handleUnauthorized();
        }
        try {
            const profileRes = await fetchWithAuth('/users/me');
            userProfile = profileRes.data || profileRes;
            renderProfile(userProfile);
        } catch (error) {
            console.error('Failed to load page:', error);
            if (error.message === 'Unauthorized') handleUnauthorized();
        }
    };

    // === Main Rendering Function ===
    const renderProfile = (profile) => {
        const p = profile.profile || {};
        const fullName = profile.name || p.name || 'N/A';
    const avatarUrl = makeFileUrl(p.avatar) || 'https://placehold.co/120x120/E2E8F0/475569?text=User';
        
        // Update Profile Header
        profileHeaderContainer.innerHTML = `
            <div class="profile-picture">
                <img src="${avatarUrl}" alt="${fullName}" id="profile-pic-img">
                <label for="profile-pic-upload" class="edit-pic"><i class="fas fa-camera"></i></label>
                <input type="file" id="profile-pic-upload" accept="image/*" style="display:none;">
            </div>
            <div class="profile-info">
                <h1>${fullName}</h1>
                <p>${p.headline || 'No headline'}</p>
                <div class="profile-contact-info">
                    <span><i class="fas fa-map-marker-alt"></i> ${p.location || 'N/A'}</span>
                    <span><i class="fas fa-envelope"></i> ${profile.email || 'N/A'}</span>
                </div>
            </div>
            <button class="btn btn-primary edit-profile-btn" data-action="open-modal" data-modal-id="edit-profile-modal">Edit Profile</button>
        `;
        document.getElementById('profile-pic-upload').addEventListener('change', handleProfilePicUpload);
        
        // Update Nav Pic, About, and Resume
    if (p.avatar) profilePicNav.src = makeFileUrl(p.avatar) || profilePicNav.src;
        aboutContainer.textContent = p.about || 'No information provided.';
    viewResumeBtn.style.display = p.resumeUrl ? 'block' : 'none';
    if (p.resumeUrl) viewResumeBtn.href = makeFileUrl(p.resumeUrl);

        // Render sections
        renderSkills(p.skills || []);
        renderExperience(p.experience || []);
        renderEducation(p.education || []);
    };

    // === Section-Specific Renderers ===
    const renderSkills = (skills) => {
        skillsContainer.innerHTML = !skills || skills.length === 0 
            ? '<p class="placeholder-text">No skills added yet.</p>'
            : skills.map(skill => `<div class="skill-tag"><span>${skill}</span><button data-action="remove-skill" data-skill="${skill}">&times;</button></div>`).join('');
    };

    const renderExperience = (experience) => {
        experienceContainer.innerHTML = !experience || experience.length === 0
            ? '<p class="placeholder-text">No experience added yet.</p>'
            : experience.map(exp => `
                <div class="list-item">
                    <div class="list-item-content">
                        <h3>${exp.title}</h3>
                        <p>${exp.company} &bull; ${exp.duration}</p>
                        <p>${exp.description || ''}</p>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn-icon" data-action="edit-experience" data-id="${exp._id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn-icon" data-action="delete-experience" data-id="${exp._id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
    };

    const renderEducation = (education) => {
        educationContainer.innerHTML = !education || education.length === 0
            ? '<p class="placeholder-text">No education added yet.</p>'
            : education.map(edu => `
                <div class="list-item">
                    <div class="list-item-content">
                        <h3>${edu.degree}</h3>
                        <p>${edu.institution} &bull; ${edu.year}</p>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn-icon" data-action="edit-education" data-id="${edu._id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn-icon" data-action="delete-education" data-id="${edu._id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
    };

    // === Modal and Form Handling ===
    const modals = document.querySelectorAll('.modal');
    const openModal = (modalId) => {
        const el = document.getElementById(modalId);
        if (el) el.style.display = 'flex';
    };
    const closeModal = () => modals.forEach(modal => modal.style.display = 'none');

    const handleOpenModal = (modalId, itemId = null) => {
        const p = userProfile.profile || {};
        if (modalId === 'edit-profile-modal') {
            const form = document.getElementById('edit-profile-form');
            form.fullName.value = userProfile.fullName || p.fullName || '';
            form.headline.value = p.headline || '';
            form.email.value = userProfile.email || '';
            document.getElementById('profile-location-input').value = p.location || '';
            form.about.value = p.about || '';
        }
        if (modalId === 'experience-modal') {
            const form = document.getElementById('experience-form');
            form.reset();
            document.getElementById('experience-modal-title').textContent = "Add Experience";
            form.id.value = '';
            if (itemId) {
                const item = (p.experience || []).find(i => i._id === itemId);
                if (item) {
                    document.getElementById('experience-modal-title').textContent = "Edit Experience";
                    form.id.value = item._id;
                    form.title.value = item.title;
                    form.company.value = item.company;
                    form.duration.value = item.duration;
                    form.description.value = item.description;
                }
            }
        }
        if (modalId === 'education-modal') {
             const form = document.getElementById('education-form');
            form.reset();
            document.getElementById('education-modal-title').textContent = "Add Education";
            form.id.value = '';
            if (itemId) {
                const item = (p.education || []).find(i => i._id === itemId);
                 if (item) {
                    document.getElementById('education-modal-title').textContent = "Edit Education";
                    form.id.value = item._id;
                    form.degree.value = item.degree;
                    form.institution.value = item.institution;
                    form.year.value = item.year;
                }
            }
        }
        openModal(modalId);
    };

    // === Event Delegation for All Actions ===
    document.body.addEventListener('click', (e) => {
        const target = e.target;
        const action = target.dataset.action || target.closest('[data-action]')?.dataset.action;
        if (!action) return;

        const modalId = target.dataset.modalId || target.closest('[data-modal-id]')?.dataset.modalId;
        if (action === 'open-modal') return handleOpenModal(modalId);
        if (action === 'close-modal') return closeModal();

        const id = target.dataset.id || target.closest('[data-id]')?.dataset.id;
        const skill = target.dataset.skill || target.closest('[data-skill]')?.dataset.skill;

        switch (action) {
            case 'remove-skill': handleRemoveSkill(skill); break;
            case 'edit-experience': handleOpenModal('experience-modal', id); break;
            case 'delete-experience': handleDeleteItem('experience', id); break;
            case 'edit-education': handleOpenModal('education-modal', id); break;
            case 'delete-education': handleDeleteItem('education', id); break;
        }
    });

    // === Form Submission Handlers ===
    const handleFormSubmit = async (e, type) => {
        e.preventDefault();
        const button = e.target.querySelector('button[type="submit"]');
        button.disabled = true;

        const formData = new FormData(e.target);
        const id = formData.get('id');
        let data = Object.fromEntries(formData.entries());
        delete data.id;

        const currentItems = (userProfile.profile && userProfile.profile[type]) || [];
        let updatedItems;

        if (id) { // Edit existing
            updatedItems = currentItems.map(item => item._id === id ? { ...item, ...data } : item);
        } else { // Add new
            updatedItems = [...currentItems, data];
        }
        
        try {
            const result = await fetchWithAuth('/users/me', {
                method: 'PUT',
                body: JSON.stringify({ profile: { [type]: updatedItems } })
            });
            userProfile = result.data || result;
            renderProfile(userProfile);
            closeModal();
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            button.disabled = false;
        }
    };
    
    document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = e.target.querySelector('button[type="submit"]');
        button.disabled = true;
        const formData = new FormData(e.target);
        const updatedData = {
            fullName: formData.get('fullName'),
            email: formData.get('email'),
            profile: {
                ...userProfile.profile, // Preserve existing profile fields
                headline: formData.get('headline'),
                location: formData.get('location'),
                about: formData.get('about')
            }
        };
        try {
            const result = await fetchWithAuth('/users/update-profile', { method: 'PUT', body: JSON.stringify(updatedData) });
            userProfile = result.data || result;
            renderProfile(userProfile);
            alert('Profile updated!');
            closeModal();
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            button.disabled = false;
        }
    });

    document.getElementById('add-skill-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newSkills = new FormData(e.target).get('skillName').split(',').map(s => s.trim()).filter(Boolean);
        if (newSkills.length === 0) return;
        
        const currentSkills = (userProfile.profile && userProfile.profile.skills) || [];
        const combinedSkills = [...new Set([...currentSkills, ...newSkills])];

        try {
            const result = await fetchWithAuth('/users/update-profile', { method: 'PUT', body: JSON.stringify({ profile: { skills: combinedSkills } }) });
            userProfile = result.data || result;
            renderSkills(userProfile.profile.skills);
            closeModal();
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            e.target.reset();
        }
    });
    
    document.getElementById('experience-form').addEventListener('submit', (e) => handleFormSubmit(e, 'experience'));
    document.getElementById('education-form').addEventListener('submit', (e) => handleFormSubmit(e, 'education'));


    // === Delete Handlers ===
    const handleDeleteItem = async (type, id) => {
        if (!confirm(`Are you sure you want to delete this ${type} entry?`)) return;

        const currentItems = (userProfile.profile && userProfile.profile[type]) || [];
        const updatedItems = currentItems.filter(item => item._id !== id);

        try {
            const result = await fetchWithAuth('/users/update-profile', {
                method: 'PUT',
                body: JSON.stringify({ profile: { [type]: updatedItems } })
            });
            userProfile = result.data || result;
            renderProfile(userProfile);
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    };

    const handleRemoveSkill = async (skillToRemove) => {
        const updatedSkills = ((userProfile.profile && userProfile.profile.skills) || []).filter(s => s !== skillToRemove);
        try {
            const result = await fetchWithAuth('/users/me', { method: 'PUT', body: JSON.stringify({ profile: { skills: updatedSkills } }) });
            userProfile = result.data || result;
            renderSkills(userProfile.profile.skills);
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    };

    // --- File Upload Handlers ---
    uploadResumeBtn.addEventListener('click', () => resumeUploadInput.click());
    resumeUploadInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('resume', file);
        uploadResumeBtn.textContent = 'Uploading...';
        uploadResumeBtn.disabled = true;
        try {
             const result = await fetchWithAuth('/users/me/resume', { method: 'POST', body: formData });
             userProfile = result.data || result;
             renderProfile(userProfile);
             alert('Resume uploaded!');
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            uploadResumeBtn.textContent = 'Upload/Update Resume';
            uploadResumeBtn.disabled = false;
        }
    });
    
    async function handleProfilePicUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('avatar', file);
        try {
            const result = await fetchWithAuth('/users/me/avatar', { method: 'POST', body: formData });
            userProfile = result.data || result;
            renderProfile(userProfile);
            alert('Profile picture updated!');
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // --- Mobile Menu Toggle ---
    const menuToggle = document.querySelector('.menu-toggle');
    const navMenu = document.querySelector('.main-nav');
    menuToggle.addEventListener('click', () => {
        navMenu.classList.toggle('active');
        const icon = menuToggle.querySelector('i');
        icon.classList.toggle('fa-bars');
        icon.classList.toggle('fa-xmark');
    });

    // --- INITIALIZATION ---
    loadPage();
});
</script>
</body>
</html>

